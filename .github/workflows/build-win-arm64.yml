name: Build Windows ARM64

on:
  # Only build when version.cljs changes (upstream releases)
  push:
    branches: [master]
    paths:
      - 'src/main/frontend/version.cljs'
  workflow_dispatch:  # Allow manual trigger
    inputs:
      test_release:
        description: 'Create test release (uses branch name in tag)'
        type: boolean
        default: false

jobs:
  # First, build rsapi for ARM64 using native ARM64 runner
  build-rsapi-arm64:
    name: Build rsapi ARM64
    runs-on: windows-11-arm
    steps:
      - name: Checkout rsapi repository
        uses: actions/checkout@v4
        with:
          repository: logseq/rsapi
          ref: '@logseq/rsapi@0.0.92'

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: 'yarn'

      - name: Install Rust toolchain
        uses: dtolnay/rust-action@stable
        with:
          toolchain: nightly-2024-12-09
          targets: aarch64-pc-windows-msvc

      - name: Add Clang to PATH
        shell: pwsh
        run: |
          # ring crate requires Clang for Windows ARM64 builds
          $vsPath = & "${env:ProgramFiles(x86)}\Microsoft Visual Studio\Installer\vswhere.exe" -latest -property installationPath
          $clangPaths = @(
            "$vsPath\VC\Tools\Llvm\ARM64\bin",
            "$vsPath\VC\Tools\Llvm\x64\bin",
            "C:\Program Files\LLVM\bin"
          )

          foreach ($path in $clangPaths) {
            if (Test-Path $path) {
              Write-Host "Found Clang at: $path"
              echo "$path" >> $env:GITHUB_PATH
              break
            }
          }

          clang --version

      - name: Install dependencies
        run: yarn install --immutable --mode=skip-build

      - name: Build rsapi for ARM64
        shell: pwsh
        env:
          CARGO_BUILD_TARGET: aarch64-pc-windows-msvc
        run: |
          yarn lerna exec "yarn build --target aarch64-pc-windows-msvc" --concurrency 1 --stream --no-prefix

      - name: Prepare rsapi artifact
        shell: pwsh
        run: |
          $nodeFile = Get-ChildItem -Path packages/rsapi -Filter "*.node" -Recurse | Select-Object -First 1
          if ($nodeFile) {
            New-Item -ItemType Directory -Force -Path "rsapi-output"
            Copy-Item $nodeFile.FullName -Destination "rsapi-output/rsapi.win32-arm64-msvc.node"
            Get-ChildItem rsapi-output/
          } else {
            Write-Error "No .node file found!"
            exit 1
          }

      - name: Upload rsapi artifact
        uses: actions/upload-artifact@v4
        with:
          name: rsapi-win32-arm64-msvc
          path: rsapi-output/
          if-no-files-found: error

  compile-cljs:
    runs-on: ubuntu-22.04
    outputs:
      version: ${{ steps.version.outputs.version }}
    steps:
      - uses: actions/checkout@v4

      - name: Get version from version.cljs
        id: version
        run: |
          VERSION=$(grep -oP 'defonce version "\K[^"]+' src/main/frontend/version.cljs)
          echo "version=$VERSION" >> $GITHUB_OUTPUT
          echo "Building version: $VERSION"

      - name: Setup Java
        uses: actions/setup-java@v4
        with:
          distribution: 'temurin'
          java-version: '21'

      - name: Setup Clojure
        uses: DeLaGuardo/setup-clojure@12.5
        with:
          cli: 1.11.1.1413

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '22'

      - name: Install dependencies
        run: yarn install

      - name: Build ClojureScript
        run: |
          yarn gulp:build
          yarn cljs:release-electron
          yarn webpack-app-build

      - name: Upload static assets
        uses: actions/upload-artifact@v4
        with:
          name: cljs-static
          path: static/

  build-windows-arm64:
    needs: [compile-cljs, build-rsapi-arm64]
    runs-on: windows-latest
    steps:
      - uses: actions/checkout@v4

      - name: Download static assets
        uses: actions/download-artifact@v4
        with:
          name: cljs-static
          path: static/

      - name: Download rsapi ARM64 binary
        uses: actions/download-artifact@v4
        with:
          name: rsapi-win32-arm64-msvc
          path: rsapi-arm64/

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '22'

      - name: Install dependencies (ARM64)
        working-directory: static
        env:
          npm_config_arch: arm64
        run: |
          git config --global url."https://github.com".insteadOf ssh://git@github.com
          git config --global url."https://github.com/".insteadOf git@github.com:
          yarn install

      - name: Download dugite ARM64 binary
        working-directory: static/node_modules/dugite
        env:
          npm_config_arch: arm64
        run: node script/download-git.js

      - name: Install rsapi ARM64 binary
        shell: pwsh
        run: |
          # Create the platform-specific rsapi package directory
          $rsapiDir = "static/node_modules/@logseq/rsapi-win32-arm64-msvc"
          New-Item -ItemType Directory -Force -Path $rsapiDir

          # Copy the built binary
          Copy-Item "rsapi-arm64/rsapi.win32-arm64-msvc.node" -Destination $rsapiDir/

          # Create package.json for the platform package
          @"
          {
            "name": "@logseq/rsapi-win32-arm64-msvc",
            "version": "0.0.92",
            "os": ["win32"],
            "cpu": ["arm64"],
            "main": "rsapi.win32-arm64-msvc.node"
          }
          "@ | Out-File -FilePath "$rsapiDir/package.json" -Encoding utf8

          Write-Host "rsapi ARM64 binary installed:"
          Get-ChildItem $rsapiDir

      - name: Build Electron ARM64
        working-directory: static
        env:
          npm_config_arch: arm64
        run: yarn electron:make-win-arm64

      - name: Prepare artifacts
        run: |
          mkdir builds
          move static\out\make\squirrel.windows\arm64\*.nupkg builds\
          move static\out\make\zip\win32\arm64\*.zip builds\
          move static\out\make\wix\arm64\Logseq.msi builds\Logseq-win-arm64.msi
        shell: cmd

      - name: Upload build artifacts
        uses: actions/upload-artifact@v4
        with:
          name: logseq-win-arm64
          path: builds/

  # Test release job - only runs on manual trigger with test_release=true
  test-release:
    needs: [compile-cljs, build-windows-arm64]
    runs-on: ubuntu-22.04
    if: github.event_name == 'workflow_dispatch' && inputs.test_release == true
    permissions:
      contents: write
    env:
      VERSION: ${{ needs.compile-cljs.outputs.version }}
      BRANCH: ${{ github.ref_name }}
    steps:
      - name: Download artifacts
        uses: actions/download-artifact@v4
        with:
          name: logseq-win-arm64
          path: ./

      - name: Create test release
        uses: softprops/action-gh-release@v2
        with:
          tag_name: test-${{ env.BRANCH }}-${{ github.run_number }}
          name: "TEST: ${{ env.BRANCH }} v${{ env.VERSION }} (#${{ github.run_number }})"
          prerelease: true
          files: |
            *.nupkg
            *.zip
            *.msi
          body: |
            ## TEST BUILD - ${{ env.BRANCH }}

            **Version:** v${{ env.VERSION }}
            **Branch:** `${{ env.BRANCH }}`
            **Run:** #${{ github.run_number }}

            This is a **test release** from a feature branch. Do not use in production.

            **Features being tested:**
            - rsapi compiled for ARM64 (Logseq Sync)
            - dugite ARM64 binary (Git integration)

            ### Installation
            - **MSI installer**: `Logseq-win-arm64.msi`
            - **Portable ZIP**: `Logseq-win32-arm64-*.zip`

  # Production release job - only runs on master branch pushes
  release:
    needs: [compile-cljs, build-windows-arm64]
    runs-on: ubuntu-22.04
    if: github.ref == 'refs/heads/master' && github.event_name == 'push'
    permissions:
      contents: write
    env:
      VERSION: ${{ needs.compile-cljs.outputs.version }}
    steps:
      - name: Download artifacts
        uses: actions/download-artifact@v4
        with:
          name: logseq-win-arm64
          path: ./

      - name: Create versioned release
        uses: softprops/action-gh-release@v2
        with:
          tag_name: ${{ env.VERSION }}-arm64
          name: Windows ARM64 v${{ env.VERSION }}
          prerelease: false
          files: |
            *.nupkg
            *.zip
            *.msi
          body: |
            ## Windows ARM64 v${{ env.VERSION }}

            This is an unofficial Windows ARM64 build based on Logseq v${{ env.VERSION }}.

            **Full functionality enabled:**
            - Core note-taking, local files, whiteboards, plugins
            - Logseq Sync (rsapi compiled for ARM64)
            - Git integration (dugite with ARM64 binary)

            ### Installation
            - **MSI installer** (recommended): `Logseq-win-arm64.msi`
            - **Portable ZIP**: `Logseq-win32-arm64-*.zip`

            See [README](https://github.com/johanclawson/logseq-win-arm64#readme) for details.

      - name: Update latest rolling release
        uses: softprops/action-gh-release@v2
        with:
          tag_name: win-arm64-latest
          name: Windows ARM64 Latest (v${{ env.VERSION }})
          prerelease: true
          files: |
            *.nupkg
            *.zip
            *.msi
          body: |
            ## Windows ARM64 Latest

            **Current version:** v${{ env.VERSION }}

            This rolling release always contains the latest ARM64 build.
            For a specific version, see the [versioned releases](https://github.com/johanclawson/logseq-win-arm64/releases).

            **Full functionality enabled:**
            - Core note-taking, local files, whiteboards, plugins
            - Logseq Sync (rsapi compiled for ARM64)
            - Git integration (dugite with ARM64 binary)
